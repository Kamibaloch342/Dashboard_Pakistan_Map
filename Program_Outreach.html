<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT Program Impact Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        /* --- BASIC SETUP & FONTS --- */
        :root {
            --bg-color: #eef1f8; /* Lighter, more modern background */
            --card-bg: #ffffff;
            --border-color: #dbe2ef; /* Softer border */
            --text-primary: #2c3a4f; /* Darker, richer text */
            --text-secondary: #7b8fa7; /* Muted secondary text */
            --accent-main: #4a69bd; /* Deep blue, slightly more muted */
            --accent-light: #e6ecfb; /* Lighter blue for backgrounds/hovers */
            --accent-success: #3cb371; /* Vibrant green */
            --accent-warning: #f1c40f; /* Clear yellow */
            --accent-danger: #e74c3c; /* Strong red */
            --shadow-elevation-1: 0 4px 12px rgba(0,0,0,0.08); /* Subtle lift */
            --shadow-elevation-2: 0 8px 20px rgba(0,0,0,0.12); /* More pronounced for hover */
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem; /* Larger for cards */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            line-height: 1.6;
        }

        * {
            box-sizing: border-box;
        }

        /* --- LAYOUT --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: auto 1fr 1fr 1fr;
            gap: 1.75rem; /* Increased gap */
            height: 100vh;
            padding: 1.75rem; /* Increased padding */
            overflow-y: auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 2rem; /* More generous padding */
            box-shadow: var(--shadow-elevation-1);
            display: flex;
            flex-direction: column;
            min-height: 0;
            transition: all 0.3s ease; /* Smooth transitions for card interactions */
        }

        /* Card Hover Effect */
        /* MODIFIED: Excluded map-card from hover effect */
        .card:hover:not(.header):not(#map-card) {
            transform: translateY(-5px);
            box-shadow: var(--shadow-elevation-2);
        }

        /* Grid Area Assignments */
        .header { grid-column: 1 / -1; }
        .overall-deck-stats-card { grid-column: 1 / 4; }
        .top-bottom-sections-card { grid-column: 4 / 7; }
        .program-outreach-card { grid-column: 7 / -1; }
        .section-by-section-matrix-card { grid-column: 1 / 7; }
        .trainer-ranking-card { grid-column: 7 / -1; }
        .section-details-card { grid-column: 1 / 7; }
        /* MODIFIED: Renamed map placeholder to map-card */
        #map-card {
            grid-column: 7 / -1;
            padding: 0; /* Remove padding to let map fill card */
            overflow: hidden; /* Ensure map corners are rounded */
        }
        /* NEW: Style for the map container div */
        #map {
            height: 100%;
            width: 100%;
            border-radius: var(--radius-lg);
        }
        
        /* --- COMPONENTS --- */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-logo img {
            height: 52px; /* Slightly larger logo */
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .header-logo h1 {
            font-size: 1.8rem; /* Larger, bolder title */
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            align-items: center;
            gap: 0.8rem; /* Adjusted gap */
            flex-wrap: wrap;
        }

        .time-display {
            text-align: right;
            padding-left: 1.5rem;
            border-left: 1px solid var(--border-color);
            line-height: 1.3;
        }

        .time-display p {
            margin: 0;
        }

        .time-display #currentTime {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-main);
        }

        .time-display #currentDate {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        select, button, input[type="date"] {
            padding: 0.75rem 1.25rem; /* More padding */
            border-radius: var(--radius-sm); /* Slightly smaller radius for inputs */
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            outline: none;
            appearance: none; /* Remove default select arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%237b8fa7'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: none;
            display: inline-block;
            cursor: pointer;
            width: 1rem;
            height: 1rem;
            margin-left: 0.5rem;
            filter: grayscale(100%) brightness(0.8); /* Mute calendar icon */
        }


        select:hover, button:hover, input[type="date"]:hover {
            border-color: var(--accent-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        button#clearFiltersBtn {
            background-color: var(--accent-light);
            color: var(--accent-main);
            border-color: var(--accent-light);
            font-weight: 600;
        }

        button#clearFiltersBtn:hover {
            background-color: var(--accent-main);
            color: var(--card-bg);
            border-color: var(--accent-main);
        }

        h3 {
            font-size: 1.3rem; /* Larger, bolder card titles */
            font-weight: 700;
            margin: 0 0 1.5rem 0; /* More margin below title */
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            flex-grow: 1;
        }

        .stat-item {
            padding: 1.25rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            text-align: center;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden; /* For radial background */
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(74,105,189,0.05) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            border-radius: 50%;
            transition: width 0.4s ease, height 0.4s ease;
            z-index: 0;
        }

        .stat-item:hover::before {
            width: 200%;
            height: 200%;
        }

        .stat-item p {
            position: relative; /* Keep text above pseudo-element */
            z-index: 1;
        }

        .stat-item p:first-child {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 0 0.5rem 0;
            font-weight: 500;
        }

        .stat-item p:last-child {
            font-size: 2.2rem; /* Even larger stat numbers */
            font-weight: 800; /* Extra bold */
            color: var(--accent-main);
            margin: 0;
            line-height: 1;
        }

        .stat-item p#totalBeneficiariesTrained { color: var(--accent-success); }
        .stat-item p#totalHandbooksDistributed { color: var(--accent-main); }
        
        /* Program Outreach specific styling */
        .outreach-segment-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 1.25rem;
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            padding: 0.4rem;
        }
        .outreach-segment-switcher button {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        .outreach-segment-switcher button.active {
            background-color: var(--accent-main);
            color: var(--card-bg);
            box-shadow: var(--shadow-elevation-1);
        }
        .outreach-segment-switcher button:not(.active):hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }


        .scrollable {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #a7b7c9 transparent;
            flex-grow: 1;
        }

        .scrollable::-webkit-scrollbar { width: 8px; } /* Slightly wider scrollbar */
        .scrollable::-webkit-scrollbar-track { background: transparent; }
        .scrollable::-webkit-scrollbar-thumb { background-color: #8c9cb1; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; } /* Rounded thumb with padding */

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 1.5rem;
            font-weight: 500;
        }

        table {
            border-collapse: separate; /* Use separate for more distinct cells with borders */
            border-spacing: 0;
            width: 100%;
            table-layout: fixed;
            border-radius: var(--radius-md); /* Apply border-radius to table */
            overflow: hidden; /* Ensure rounded corners are visible */
        }

        th, td {
            padding: 1rem 0.8rem; /* More padding */
            font-size: 0.88rem; /* Slightly larger font */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color); /* Add right border for grid effect */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        th:last-child, td:last-child {
            border-right: none; /* No right border on last column */
        }

        thead th {
            position: sticky;
            top: 0;
            background-color: #f6f8fc; /* Lighter header background */
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.78rem;
            border-top: none; /* No top border if table has radius */
            border-bottom: 2px solid var(--border-color); /* Stronger bottom border for header */
        }

        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        tbody tr.selected {
            background-color: var(--accent-main) !important;
            color: white;
            box-shadow: inset 0 0 0 2px var(--accent-main), 0 4px 15px rgba(0,0,0,0.2); /* Stronger selection */
            transform: translateY(-2px) scale(1.005);
        }
        tbody tr.selected td {
            color: white;
        }
        tbody tr.selected .coverage-bar-full span {
            color: white;
        }


        .coverage-bar-full {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            width: 100%;
        }

        .bar-container {
            flex-grow: 1;
            height: 10px; /* Thicker bar */
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-out; /* Slower, smoother animation */
            animation: fadeIn 0.8s ease-out; /* Fade in animation */
        }

        .coverage-bar-full span {
            font-weight: 600;
            width: 40px; /* Wider for percentage text */
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        /* Static chart (Top/Bottom Sections & Section Details) */
        .static-chart-container {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* More space between bars */
            flex-grow: 1;
            justify-content: center;
        }

        .static-bar-item {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 0.9rem;
        }

        .static-bar-label {
            width: 100px; /* Wider label */
            min-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
            font-weight: 500;
        }

        .static-bar-wrapper {
            flex-grow: 1;
            height: 16px; /* Even thicker bar */
            background-color: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); /* Inner shadow for depth */
        }

        .static-bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.6s ease-out; /* Slower, smoother animation */
            animation: slideIn 0.8s ease-out; /* Slide in animation */
        }

        .static-bar-value {
            font-weight: 700;
            font-size: 0.85rem;
            width: 40px;
            text-align: right;
            color: var(--text-primary);
        }

        /* Section Details layout */
        .section-details-card > div {
            display: flex;
            flex-grow: 1;
            gap: 2.5rem; /* Larger gap */
            align-items: flex-start; /* Align content to the top */
        }
        .section-details-card .scrollable {
            max-height: 200px; /* Limit height of feedback scrollable */
            padding-right: 0.5rem; /* For scrollbar space */
        }
        .section-details-card ul {
            list-style: none; /* Remove default list style */
            margin:0;
            padding-left: 0;
            font-size: 0.85rem;
        }
        .section-details-card ul li {
            margin-bottom: 0.7rem;
            line-height: 1.5;
            padding-left: 1.5rem;
            position: relative;
        }
        .section-details-card ul li::before {
            content: '•'; /* Custom bullet point */
            color: var(--accent-main);
            position: absolute;
            left: 0;
            font-size: 1.2em;
            line-height: 1;
            top: 0;
        }
        .section-details-card strong {
            color: var(--text-primary);
        }
        .section-details-card p {
            margin: 0;
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { width: 0; opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: repeat(8, 1fr);
                gap: 1.5rem;
                padding: 1.5rem;
            }
            .overall-deck-stats-card { grid-column: 1 / 5; }
            .top-bottom-sections-card { grid-column: 5 / 9; }
            .program-outreach-card { grid-column: 1 / 9; }
            .section-by-section-matrix-card { grid-column: 1 / 9; }
            .trainer-ranking-card { grid-column: 1 / 9; }
            .section-details-card { grid-column: 1 / 9; }
            #map-card { grid-column: 1 / 9; } /* MODIFIED: Responsive map */
            .header-logo h1 { font-size: 1.6rem; }
            h3 { font-size: 1.2rem; }
            .stat-item p:last-child { font-size: 2rem; }
        }

        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.25rem;
                padding: 1.25rem;
            }
            .overall-deck-stats-card, .top-bottom-sections-card, .program-outreach-card,
            .section-by-section-matrix-card, .trainer-ranking-card, .section-details-card,
            #map-card { /* MODIFIED: Responsive map */
                grid-column: 1 / -1; /* All cards span full width */
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            .filters {
                width: 100%;
                justify-content: center;
                flex-direction: column; /* Stack filters vertically */
                align-items: stretch;
            }
            .time-display {
                border-left: none;
                padding-left: 0;
                text-align: center;
                width: 100%;
            }
            .section-details-card > div {
                flex-direction: column;
            }
            .section-details-card > div > div {
                width: 100%;
                padding-left: 0;
                padding-right: 0;
                border-left: none;
            }
            .static-bar-label { width: 80px; min-width: 80px; }
            .outreach-segment-switcher {
                flex-direction: column; /* Stack buttons */
            }
        }

        @media (max-width: 600px) {
            .dashboard-grid {
                padding: 1rem;
                gap: 1rem;
            }
            .card {
                padding: 1.5rem;
            }
            #map-card { padding: 0; } /* MODIFIED: Ensure map fills card on mobile */
            .header-logo img { height: 45px; }
            .header-logo h1 { font-size: 1.4rem; }
            h3 { font-size: 1.1rem; margin-bottom: 1rem;}
            .stat-item p:last-child { font-size: 1.8rem; }
            .filters select, .filters button, .filters input {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }
            th, td { padding: 0.7rem 0.5rem; font-size: 0.8rem; }
            .static-bar-label { width: 70px; min-width: 70px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <header class="card header">
            <div class="header-content">
                <div class="header-logo">
                    <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="SDPI Logo">
                    <h1>DFLT Program Impact Dashboard</h1>
                </div>
                <div class="filters">
                    <input type="date" id="startDateFilter" title="Start Date">
                    <input type="date" id="endDateFilter" title="End Date">
                    <select id="provinceFilter" title="Filter by Province"></select>
                    <select id="globalTrainerFilter" title="Filter by Trainer"></select>
                    <button id="clearFiltersBtn">Clear All Filters</button>
                    <div class="time-display">
                        <p id="currentTime"></p>
                        <p id="currentDate"></p>
                    </div>
                </div>
            </div>
        </header>

        <div class="card overall-deck-stats-card">
            <h3>Overall Deck Engagement</h3>
            <div class="stats-grid">
                <div class="stat-item"><p>Total Sections</p><p id="totalDeckSections">-</p></div>
                <div class="stat-item"><p>Sessions Tracked</p><p id="totalSessionsTracked">-</p></div>
                <div class="stat-item"><p>Avg. Main Coverage</p><p id="avgMainSectionCoverage">-</p></div>
                <div class="stat-item"><p>Avg. Sub-Concept</p><p id="avgSubConceptCoverage">-</p></div>
            </div>
        </div>

        <div class="card top-bottom-sections-card">
            <h3>Section Coverage Overview</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.75rem; flex-grow: 1;">
                <div><p style="font-weight: 600; font-size: 1rem; margin: 0 0 1rem 0;">Most Covered</p><div id="mostCoveredChart" class="static-chart-container"></div></div>
                <div><p style="font-weight: 600; font-size: 1rem; margin: 0 0 1rem 0;">Least Covered</p><div id="leastCoveredChart" class="static-chart-container"></div></div>
            </div>
        </div>

        <div class="card program-outreach-card">
            <h3>Program Outreach</h3>
            <div class="outreach-segment-switcher">
                <button id="outreachAll" class="active" data-segment="All">All Locations</button>
                <button id="outreachUrban" data-segment="Urban">Urban</button>
                <button id="outreachRural" data-segment="Rural">Rural</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><p>Total Beneficiaries Trained</p><p id="totalBeneficiariesTrained">-</p></div>
                <div class="stat-item"><p>Total Handbooks Distributed</p><p id="totalHandbooksDistributed">-</p></div>
            </div>
        </div>

        <div class="card section-by-section-matrix-card">
            <h3>Section-by-Section Performance Matrix</h3>
            <div id="sectionMatrix" class="scrollable"></div>
        </div>

        <div class="card trainer-ranking-card">
            <h3>Trainer Ranking by Target Achievement</h3>
            <div id="trainerRankingTable" class="scrollable"></div>
        </div>

        <div class="card section-details-card">
            <h3 id="sectionDetailsTitle">Details for...</h3>
            <div id="sectionDetailsContainer" class="empty-state">Select a section from the matrix to see details.</div>
        </div>

        <div id="map-card" class="card">
            <div id="map"></div>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// Encapsulated, self-contained dashboard logic.
const DashboardApp = {
    // --- MASTER DATA & CONFIG ---
    SYLLABUS: { "Intro": ["BISP Intro", "Storytelling"], "Money Mgmt": ["Know When", "Count & Confirm", "No Deductions"], "Financial Plan": ["Budgeting", "Saving", "Investment"], "Banking": ["Account Types", "Bank Services", "ATM Demo"], "Risks": ["Fraud Types", "Loan Mgmt", "NSER Importance"], "Practical": ["Calculator Use", "Saving Number", "Reading SMS"] },
    mockTrainingSessionData: [
        // Added Location_Type: "Urban" or "Rural"
        { SessionID: "TS001", Trainer: "Ali Raza", Province: "Punjab", Date: "2025-07-25", GPS: [31.52, 74.35], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: { "Intro": "Audience loved the opening story.", "Banking": "ATM Demo needs better visual aids." }, Time_Spent_Per_Section: { "Intro": 20, "Money Mgmt": 30, "Financial Plan": 40, "Banking": 25, "Risks": 35, "Practical": 15 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 4, "Financial Plan": 5, "Banking": 3, "Risks": 4, "Practical": 4 }, Trainer_Rating: 8.5, Beneficiaries_Trained: 50, Handbooks_Distributed: 48 },
        { SessionID: "TS002", Trainer: "Sana Khan", Province: "Sindh", Date: "2025-07-24", GPS: [24.86, 67.01], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 18, "Money Mgmt": 28, "Financial Plan": 38, "Banking": 30, "Risks": 32, "Practical": 20 }, Audience_Engagement_Per_Section: { "Intro": 4, "Money Mgmt": 5, "Financial Plan": 4, "Banking": 4, "Risks": 4, "Practical": 5 }, Trainer_Rating: 9.0, Beneficiaries_Trained: 60, Handbooks_Distributed: 55 },
        { SessionID: "TS003", Trainer: "Usman Malik", Province: "KPK", Date: "2025-07-23", GPS: [34.01, 71.52], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Account Types", "Bank Services", "ATM Demo", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: { "Risks": "Ran out of time here, felt rushed." }, Time_Spent_Per_Section: { "Intro": 15, "Money Mgmt": 25, "Financial Plan": 30, "Banking": 20, "Risks": 10, "Practical": 12 }, Audience_Engagement_Per_Section: { "Intro": 3, "Money Mgmt": 4, "Financial Plan": 3, "Banking": 2, "Risks": 1, "Practical": 3 }, Trainer_Rating: 7.0, Beneficiaries_Trained: 35, Handbooks_Distributed: 30 },
        { SessionID: "TS004", Trainer: "Fatima Ahmed", Province: "Balochistan", Date: "2025-07-22", GPS: [30.21, 67.01], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: { "Banking": "Found banking theory hard to explain without physical examples." }, Time_Spent_Per_Section: { "Intro": 22, "Money Mgmt": 35, "Financial Plan": 45, "Banking": 15, "Risks": 30, "Practical": 18 }, Audience_Engagement_Per_Section: { "Intro": 4, "Money Mgmt": 4, "Financial Plan": 4, "Banking": 2, "Risks": 3, "Practical": 4 }, Trainer_Rating: 7.5, Beneficiaries_Trained: 45, Handbooks_Distributed: 40 },
        { SessionID: "TS005", Trainer: "Ali Raza", Province: "Punjab", Date: "2025-07-21", GPS: [31.41, 73.07], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 20, "Money Mgmt": 30, "Financial Plan": 40, "Banking": 25, "Risks": 35, "Practical": 15 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 4, "Financial Plan": 5, "Banking": 4, "Risks": 4, "Practical": 4 }, Trainer_Rating: 8.8, Beneficiaries_Trained: 55, Handbooks_Distributed: 50 },
        { SessionID: "TS006", Trainer: "Sana Khan", Province: "Sindh", Date: "2025-07-20", GPS: [24.90, 67.05], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: { "Risks": "Forgot to emphasize loan management, need to remember for next time." }, Time_Spent_Per_Section: { "Intro": 18, "Money Mgmt": 28, "Financial Plan": 38, "Banking": 30, "Risks": 20, "Practical": 20 }, Audience_Engagement_Per_Section: { "Intro": 4, "Money Mgmt": 5, "Financial Plan": 4, "Banking": 4, "Risks": 3, "Practical": 5 }, Trainer_Rating: 8.9, Beneficiaries_Trained: 65, Handbooks_Distributed: 60 },
        { SessionID: "TS007", Trainer: "Usman Malik", Province: "Punjab", Date: "2025-07-19", GPS: [31.50, 74.30], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Know When", "Count & Confirm", "Budgeting", "Saving", "Account Types", "Fraud Types", "Loan Mgmt", "Calculator Use"], Trainer_Feedback_Deck_Section: { "Intro": "Storytelling felt less impactful this time.", "Practical": "Saving Number concept needs more local examples." }, Time_Spent_Per_Section: { "Intro": 10, "Money Mgmt": 20, "Financial Plan": 25, "Banking": 15, "Risks": 25, "Practical": 10 }, Audience_Engagement_Per_Section: { "Intro": 2, "Money Mgmt": 3, "Financial Plan": 3, "Banking": 2, "Risks": 3, "Practical": 2 }, Trainer_Rating: 6.5, Beneficiaries_Trained: 40, Handbooks_Distributed: 38 },
        { SessionID: "TS008", Trainer: "Fatima Ahmed", Province: "KPK", Date: "2025-07-18", GPS: [34.05, 71.50], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 22, "Money Mgmt": 35, "Financial Plan": 45, "Banking": 28, "Risks": 30, "Practical": 18 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 5, "Financial Plan": 5, "Banking": 4, "Risks": 4, "Practical": 4 }, Trainer_Rating: 9.2, Beneficiaries_Trained: 70, Handbooks_Distributed: 65 },
        { SessionID: "TS009", Trainer: "Ali Raza", Province: "Sindh", Date: "2025-07-17", GPS: [25.00, 67.10], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 20, "Money Mgmt": 30, "Financial Plan": 40, "Banking": 25, "Risks": 35, "Practical": 15 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 4, "Financial Plan": 5, "Banking": 4, "Risks": 4, "Practical": 4 }, Trainer_Rating: 8.7, Beneficiaries_Trained: 52, Handbooks_Distributed: 50 },
        { SessionID: "TS010", Trainer: "Usman Malik", Province: "Balochistan", Date: "2025-07-16", GPS: [30.25, 66.90], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: { "Banking": "Audience confused on digital banking, need more examples." }, Time_Spent_Per_Section: { "Intro": 18, "Money Mgmt": 28, "Financial Plan": 35, "Banking": 18, "Risks": 30, "Practical": 15 }, Audience_Engagement_Per_Section: { "Intro": 4, "Money Mgmt": 3, "Financial Plan": 4, "Banking": 2, "Risks": 3, "Practical": 3 }, Trainer_Rating: 7.2, Beneficiaries_Trained: 48, Handbooks_Distributed: 45 },
        { SessionID: "TS011", Trainer: "Sana Khan", Province: "Punjab", Date: "2025-07-15", GPS: [30.70, 72.30], Location_Type: "Urban", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 20, "Money Mgmt": 30, "Financial Plan": 40, "Banking": 25, "Risks": 35, "Practical": 15 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 4, "Financial Plan": 5, "Banking": 4, "Risks": 4, "Practical": 4 }, Trainer_Rating: 9.1, Beneficiaries_Trained: 75, Handbooks_Distributed: 70 },
        { SessionID: "TS012", Trainer: "Fatima Ahmed", Province: "Sindh", Date: "2025-07-14", GPS: [24.80, 67.00], Location_Type: "Rural", Concepts_Covered: ["BISP Intro", "Storytelling", "Know When", "Count & Confirm", "No Deductions", "Budgeting", "Saving", "Investment", "Account Types", "Bank Services", "ATM Demo", "Fraud Types", "Loan Mgmt", "NSER Importance", "Calculator Use", "Saving Number", "Reading SMS"], Trainer_Feedback_Deck_Section: {}, Time_Spent_Per_Section: { "Intro": 22, "Money Mgmt": 35, "Financial Plan": 45, "Banking": 28, "Risks": 30, "Practical": 18 }, Audience_Engagement_Per_Section: { "Intro": 5, "Money Mgmt": 5, "Financial Plan": 5, "Banking": 4, "Risks": 4, "Practical": 4 }, Trainer_Rating: 9.3, Beneficiaries_Trained: 68, Handbooks_Distributed: 62 },
    ],
    mockTrainerTargets: { "Ali Raza": 200, "Sana Khan": 250, "Usman Malik": 180, "Fatima Ahmed": 220 },

    // --- APP STATE ---
    filters: { province: 'All', trainer: 'All', startDate: null, endDate: null, locationType: 'All' },
    selected: { mainSection: null },
    // NEW: Add map and marker layer to app state
    map: null,
    markerLayer: null,

    /**
     * Initializes the entire application.
     */
    init() {
        this.setupEventListeners();
        this.initMap(); // NEW: Initialize the map
        this.updateTime();
        setInterval(() => this.updateTime(), 1000);
        this.populateFilters();
        this.updateDashboard();
    },

    /**
     * Sets up all event listeners for filters and interactive elements.
     */
    setupEventListeners() {
        document.getElementById('provinceFilter').addEventListener('change', (e) => this.handleFilterChange('province', e.target.value));
        document.getElementById('globalTrainerFilter').addEventListener('change', (e) => this.handleFilterChange('trainer', e.target.value));
        document.getElementById('startDateFilter').addEventListener('change', (e) => this.handleFilterChange('startDate', e.target.value));
        document.getElementById('endDateFilter').addEventListener('change', (e) => this.handleFilterChange('endDate', e.target.value));
        document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearFilters());

        // Outreach segment buttons
        document.getElementById('outreachAll').addEventListener('click', () => this.handleLocationTypeChange('All'));
        document.getElementById('outreachUrban').addEventListener('click', () => this.handleLocationTypeChange('Urban'));
        document.getElementById('outreachRural').addEventListener('click', () => this.handleLocationTypeChange('Rural'));
    },
    
    /**
     * The main update function. It gets fresh data based on filters
     * and calls all the render methods to update the UI.
     */
    updateDashboard() {
        const filteredData = this.getFilteredData();
        // If no section is selected, or the selected section is no longer valid after filtering,
        // default to the first section in the SYLLABUS.
        if (!this.selected.mainSection || !this.SYLLABUS[this.selected.mainSection]) {
            this.selected.mainSection = Object.keys(this.SYLLABUS)[0];
        }
        
        this.renderOverallStats(filteredData);
        this.renderTopBottomSections(filteredData);
        this.renderProgramOutreach(filteredData);
        this.renderSectionMatrix(filteredData);
        this.renderTrainerRanking(filteredData);
        this.renderSectionDetails(filteredData); // Always render details for the selected section
        this.updateMapMarkers(filteredData); // NEW: Update the map markers

        // Manage 'selected' class for table rows
        document.querySelectorAll('#sectionMatrix tbody tr, #trainerRankingTable tbody tr').forEach(r => r.classList.remove('selected'));
        if (this.selected.mainSection) {
            const sectionRow = document.getElementById(`section-row-${this.selected.mainSection.replace(/\s/g, '-')}`);
            if (sectionRow) sectionRow.classList.add('selected');
        }
        if (this.filters.trainer !== 'All') {
            const trainerRow = document.getElementById(`trainer-row-${this.filters.trainer.replace(/\s/g, '-')}`);
            if (trainerRow) trainerRow.classList.add('selected');
        }
        this.updateLocationTypeButtons();
    },
    
    getFilteredData() {
        const { province, trainer, startDate, endDate, locationType } = this.filters;
        return this.mockTrainingSessionData.filter(item => {
            const itemDate = new Date(item.Date);
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;

            // Normalize dates for comparison (ignore time part)
            if (start) start.setHours(0, 0, 0, 0);
            if (end) end.setHours(23, 59, 59, 999);
            // Don't normalize itemDate, use its own date
            const itemDateOnly = new Date(itemDate);
            itemDateOnly.setHours(0, 0, 0, 0);

            return (province === 'All' || item.Province === province) &&
                   (trainer === 'All' || item.Trainer === trainer) &&
                   (!start || itemDateOnly >= start) &&
                   (!end || itemDateOnly <= end) &&
                   (locationType === 'All' || item.Location_Type === locationType);
        });
    },

    // --- RENDER FUNCTIONS --- //
    renderOverallStats(data) {
        const totalSessions = data.length;
        let mainSectionsCoveredInstances = 0;
        let subConceptsCoveredInstances = 0;
        const totalPossibleMainSectionInstances = Object.keys(this.SYLLABUS).length * totalSessions;
        const totalPossibleSubConceptInstances = Object.values(this.SYLLABUS).flat().length * totalSessions;

        data.forEach(session => {
            Object.entries(this.SYLLABUS).forEach(([main, subs]) => {
                const coveredSubs = subs.filter(sc => session.Concepts_Covered.includes(sc));
                if (subs.length > 0 && coveredSubs.length === subs.length) {
                    mainSectionsCoveredInstances++;
                }
                subConceptsCoveredInstances += coveredSubs.length;
            });
        });

        const avgMainCoverage = totalPossibleMainSectionInstances > 0 ? (mainSectionsCoveredInstances / totalPossibleMainSectionInstances * 100) : 0;
        const avgSubCoverage = totalPossibleSubConceptInstances > 0 ? (subConceptsCoveredInstances / totalPossibleSubConceptInstances * 100) : 0;

        document.getElementById('totalDeckSections').textContent = Object.keys(this.SYLLABUS).length;
        document.getElementById('totalSessionsTracked').textContent = totalSessions.toLocaleString();
        document.getElementById('avgMainSectionCoverage').textContent = `${avgMainCoverage.toFixed(1)}%`;
        document.getElementById('avgSubConceptCoverage').textContent = `${avgSubCoverage.toFixed(1)}%`;
    },

    renderTopBottomSections(data) {
        const createStaticBar = (item) => {
            const color = item.value >= 80 ? 'var(--accent-success)' : item.value > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
            return `<div class="static-bar-item" title="${item.label}: ${item.value.toFixed(1)}%"><div class="static-bar-label">${item.label}</div><div class="static-bar-wrapper"><div class="static-bar-fill" style="width: ${item.value}%; background-color: ${color};"></div></div><div class="static-bar-value">${item.value.toFixed(0)}%</div></div>`;
        };

        if (data.length === 0) {
            document.getElementById('mostCoveredChart').innerHTML = '<div class="empty-state">No data</div>';
            document.getElementById('leastCoveredChart').innerHTML = '<div class="empty-state">No data</div>';
            return;
        }

        const sectionCoverage = Object.keys(this.SYLLABUS).map(mainSection => {
            const subs = this.SYLLABUS[mainSection];
            let fullyCoveredCount = data.filter(s => subs.length > 0 && subs.every(sc => s.Concepts_Covered.includes(sc))).length;
            return { label: mainSection, value: data.length > 0 ? (fullyCoveredCount / data.length * 100) : 0 };
        });

        sectionCoverage.sort((a, b) => a.value - b.value);
        document.getElementById('leastCoveredChart').innerHTML = sectionCoverage.slice(0, 5).map(createStaticBar).join('');
        document.getElementById('mostCoveredChart').innerHTML = sectionCoverage.slice(-5).reverse().map(createStaticBar).join('');
    },
    
    renderProgramOutreach(data) {
        const outreachData = data.filter(s => this.filters.locationType === 'All' || s.Location_Type === this.filters.locationType);
        document.getElementById('totalBeneficiariesTrained').textContent = outreachData.reduce((sum, s) => sum + s.Beneficiaries_Trained, 0).toLocaleString();
        document.getElementById('totalHandbooksDistributed').textContent = outreachData.reduce((sum, s) => sum + s.Handbooks_Distributed, 0).toLocaleString();
    },

    renderSectionMatrix(data) {
        const container = document.getElementById('sectionMatrix');
        if (data.length === 0) { container.innerHTML = '<div class="empty-state">No section data for current filters.</div>'; return; }
        
        let tbodyHTML = '';
        Object.entries(this.SYLLABUS).forEach(([mainSection, subs]) => {
            let fullyCoveredSessions = 0;
            let totalSubConceptsCoveredForThisMainSection = 0;

            data.forEach(s => {
                const coveredSubsCount = subs.filter(sc => s.Concepts_Covered.includes(sc)).length;
                if (subs.length > 0 && coveredSubsCount === subs.length) {
                    fullyCoveredSessions++;
                }
                totalSubConceptsCoveredForThisMainSection += coveredSubsCount;
            });

            const overallCoverage = data.length > 0 ? (fullyCoveredSessions / data.length) * 100 : 0;
            const totalPossibleSubConceptsInThisSection = subs.length * data.length;
            const avgSubCoverage = totalPossibleSubConceptsInThisSection > 0 ? (totalSubConceptsCoveredForThisMainSection / totalPossibleSubConceptsInThisSection) * 100 : 0;
            const color = (val) => val >= 80 ? 'var(--accent-success)' : val > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
            
            tbodyHTML += `<tr id="section-row-${mainSection.replace(/\s/g, '-')}" onclick="DashboardApp.selectMainSection('${mainSection}')">
                            <td style="text-align: left; width: 40%; font-weight: 500;">${mainSection}</td>
                            <td><div class="coverage-bar-full"><div class="bar-container"><div class="bar-fill" style="width:${overallCoverage.toFixed(0)}%; background-color:${color(overallCoverage)};"></div></div><span>${overallCoverage.toFixed(0)}%</span></div></td>
                            <td><div class="coverage-bar-full"><div class="bar-container"><div class="bar-fill" style="width:${avgSubCoverage.toFixed(0)}%; background-color:${color(avgSubCoverage)};"></div></div><span>${avgSubCoverage.toFixed(0)}%</span></div></td>
                        </tr>`;
        });
        container.innerHTML = `<table><thead><tr><th style="text-align: left; width: 40%;">Main Section</th><th>Full Coverage Rate</th><th>Avg. Sub-Concept Coverage</th></tr></thead><tbody>${tbodyHTML}</tbody></table>`;
    },
    
    renderTrainerRanking(data) {
        const container = document.getElementById('trainerRankingTable');
        const trainerPerformance = {};
        data.forEach(s => {
            if (!trainerPerformance[s.Trainer]) trainerPerformance[s.Trainer] = { trained: 0, target: this.mockTrainerTargets[s.Trainer] || 0 };
            trainerPerformance[s.Trainer].trained += s.Beneficiaries_Trained;
        });

        const rankedTrainers = Object.entries(trainerPerformance).map(([name, p]) => ({
            name, trained: p.trained, achievement: p.target > 0 ? (p.trained / p.target * 100) : 0,
        })).sort((a, b) => b.achievement - a.achievement);

        if (rankedTrainers.length === 0) { container.innerHTML = '<div class="empty-state">No trainer data for current filters.</div>'; return; }

        let tbodyHTML = rankedTrainers.map((trainer, index) => {
            const color = (val) => val >= 90 ? 'var(--accent-success)' : val > 60 ? 'var(--accent-warning)' : 'var(--accent-danger)';
            return `<tr id="trainer-row-${trainer.name.replace(/\s/g, '-')}" onclick="DashboardApp.selectTrainer('${trainer.name}')">
                        <td style="font-weight: 700;">${index + 1}</td>
                        <td style="text-align: left;">${trainer.name}</td>
                        <td>${trainer.trained.toLocaleString()}</td>
                        <td><div class="coverage-bar-full"><div class="bar-container"><div class="bar-fill" style="width:${Math.min(trainer.achievement, 100).toFixed(0)}%; background-color:${color(trainer.achievement)};"></div></div><span>${trainer.achievement.toFixed(0)}%</span></div></td>
                    </tr>`;
        }).join('');
        container.innerHTML = `<table><thead><tr><th style="width: 10%;">Rank</th><th style="text-align: left; width: 30%;">Trainer</th><th style="width: 20%;">Trained</th><th style="width: 40%;">Target % Achieved</th></tr></thead><tbody>${tbodyHTML}</tbody></table>`;
    },

    renderSectionDetails(data) {
        const container = document.getElementById('sectionDetailsContainer');
        const sectionName = this.selected.mainSection;
        
        document.getElementById('sectionDetailsTitle').textContent = `Details for ${sectionName || '...'}`;
        if (!sectionName || data.length === 0) {
            container.innerHTML = '<div class="empty-state">Select a section from the matrix to see details.</div>';
            return;
        }

        const createStaticBar = (item) => {
            const color = item.value >= 80 ? 'var(--accent-success)' : item.value > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
            return `<div class="static-bar-item" title="${item.label}: ${item.value.toFixed(1)}%"><div class="static-bar-label">${item.label}</div><div class="static-bar-wrapper"><div class="static-bar-fill" style="width: ${item.value}%; background-color: ${color};"></div></div><div class="static-bar-value">${item.value.toFixed(0)}%</div></div>`;
        };

        const subConcepts = this.SYLLABUS[sectionName];
        if (!subConcepts || subConcepts.length === 0) {
             container.innerHTML = `<div class="empty-state">No sub-concepts defined for "${sectionName}".</div>`;
             return;
        }

        const subConceptCoverage = subConcepts.map(subConcept => {
            let coveredCount = data.filter(session => session.Concepts_Covered.includes(subConcept)).length;
            return { label: subConcept, value: data.length > 0 ? (coveredCount / data.length * 100) : 0 };
        });
        
        const feedbackNotes = data.filter(s => s.Trainer_Feedback_Deck_Section?.[sectionName] && s.Trainer_Feedback_Deck_Section[sectionName].trim() !== '');
        let feedbackHtml = feedbackNotes.length > 0 ? `<ul style="margin:0; padding-left: 0; font-size: 0.85rem; list-style-type: none;">${feedbackNotes.map(s => `<li><strong>${s.Trainer}:</strong> ${s.Trainer_Feedback_Deck_Section[sectionName]}</li>`).join('')}</ul>` : `<p style="font-size: 0.85rem; color: var(--text-secondary);">No specific feedback recorded for this section with current filters.</p>`;

        container.innerHTML = `
            <div style="flex: 1; min-width: 280px;">
                <p style="font-weight: 600; font-size: 1rem; margin: 0 0 1rem 0;">Sub-Concept Coverage</p>
                <div class="static-chart-container">${subConceptCoverage.map(createStaticBar).join('')}</div>
            </div>
            <div style="flex: 1; min-width: 280px; padding-left: 2rem; border-left: 1px solid var(--border-color);">
                <p style="font-weight: 600; font-size: 1rem; margin: 0 0 1rem 0;">Trainer Feedback & Notes</p>
                <div class="scrollable" style="max-height: 200px;">${feedbackHtml}</div>
            </div>`;
    },
    
    // --- NEW: MAP FUNCTIONS --- //
    initMap() {
        if (this.map) return; // Prevent re-initialization
        // Initialize map centered on Pakistan
        this.map = L.map('map').setView([30.3753, 69.3451], 5);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(this.map);
        
        // Create a layer group to hold markers for easy clearing
        this.markerLayer = L.layerGroup().addTo(this.map);
    },

    updateMapMarkers(data) {
        if (!this.map || !this.markerLayer) return;

        this.markerLayer.clearLayers(); // Clear previous markers
        const markers = [];

        data.forEach(session => {
            if (session.GPS && session.GPS.length === 2) {
                const marker = L.marker(session.GPS);
                // Add a popup with session info
                marker.bindPopup(`
                    <strong>Trainer:</strong> ${session.Trainer}<br>
                    <strong>Province:</strong> ${session.Province}<br>
                    <strong>Date:</strong> ${new Date(session.Date).toLocaleDateString()}<br>
                    <strong>Location Type:</strong> ${session.Location_Type}
                `);
                markers.push(marker);
            }
        });

        if (markers.length > 0) {
            markers.forEach(m => this.markerLayer.addLayer(m));
            // Adjust map bounds to fit all visible markers
            const group = new L.featureGroup(markers);
            this.map.fitBounds(group.getBounds().pad(0.2));
        } else {
            // If no markers, reset view to the default for Pakistan
            this.map.setView([30.3753, 69.3451], 5);
        }
    },

    // --- ACTIONS & HELPERS --- //
    handleFilterChange(key, value) { 
        this.filters[key] = value; 
        if (key === 'province') { 
            this.filters.trainer = 'All'; // Reset trainer filter when province changes
            document.getElementById('globalTrainerFilter').value = 'All'; // Update UI too
            this.populateGlobalTrainerFilter(); 
        } 
        this.updateDashboard(); 
    },

    handleLocationTypeChange(type) {
        this.filters.locationType = type;
        this.updateDashboard(); // Re-render everything, which will update all cards including the map
    },

    updateLocationTypeButtons() {
        document.querySelectorAll('.outreach-segment-switcher button').forEach(button => {
            button.classList.remove('active');
            if (button.dataset.segment === this.filters.locationType) {
                button.classList.add('active');
            }
        });
    },

    clearFilters() { 
        this.filters = { province: 'All', trainer: 'All', startDate: null, endDate: null, locationType: 'All' }; 
        document.getElementById('provinceFilter').value = 'All'; 
        this.populateGlobalTrainerFilter();
        document.getElementById('globalTrainerFilter').value = 'All'; 
        document.getElementById('startDateFilter').value = ''; 
        document.getElementById('endDateFilter').value = ''; 
        this.updateDashboard(); 
    },

    selectMainSection(sectionName) { 
        this.selected.mainSection = sectionName; 
        this.updateDashboard(); 
    },

    selectTrainer(trainerName) { 
        this.filters.trainer = trainerName; 
        document.getElementById('globalTrainerFilter').value = trainerName; 
        this.updateDashboard(); 
    },

    populateFilters() { 
        const provFilter = document.getElementById('provinceFilter'); 
        const uniqueProvinces = [...new Set(this.mockTrainingSessionData.map(d => d.Province))].sort(); 
        provFilter.innerHTML = ['<option value="All">All Provinces</option>', ...uniqueProvinces.map(val => `<option value="${val}">${val}</option>`)].join(''); 
        this.populateGlobalTrainerFilter(); 
    },

    populateGlobalTrainerFilter() { 
        const trainerFilter = document.getElementById('globalTrainerFilter'); 
        const province = this.filters.province; 
        const trainers = province === 'All' 
            ? [...new Set(this.mockTrainingSessionData.map(d => d.Trainer))] 
            : [...new Set(this.mockTrainingSessionData.filter(d => d.Province === province).map(d => d.Trainer))]; 
        trainerFilter.innerHTML = ['<option value="All">All Trainers</option>', ...trainers.sort().map(val => `<option value="${val}">${val}</option>`)].join(''); 
        if (this.filters.trainer !== 'All' && !trainers.includes(this.filters.trainer)) {
            this.filters.trainer = 'All';
            trainerFilter.value = 'All';
        } else {
            trainerFilter.value = this.filters.trainer;
        }
    },

    updateTime() {
        const now = new Date();
        const timeOpts = { hour: '2-digit', minute: '2-digit', hour12: true };
        const dateOpts = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOpts);
        document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOpts);
    },
};

// Start the application when the DOM is ready
document.addEventListener('DOMContentLoaded', () => DashboardApp.init());
</script>
</body>
</html>